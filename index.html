<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login & Register Citizenship</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
  body {
    background-image: url('https://images.pexels.com/photos/255379/pexels-photo-255379.jpeg?cs=srgb&dl=pexels-padrinan-255379.jpg&fm=jpg'); /* Replace with your image URL */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #f8f9fa; /* Fallback color */
  }
  .container {
    margin-top: 50px;
    background-color:transparent; /* Adds a slight background to the form for better readability */
    border-radius: 8px;
    padding: 20px;
  }
  .card {
    margin: 20px 0;
    border: none;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    background-color: rgba(255, 255, 255, 0.95);
  }
  .card-header {
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
  }
  .icon {
    font-size: 2rem;
    margin-right: 10px;
  }

  .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .logo-section img {
      width: 100px;
      height: auto;
      margin-top: 10px;
    }
    .logo-section h1 {
      font-size: 2rem;
      font-weight: bold;
      color: white;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="logo-section">
  <img src="img/logo.jpeg" alt="Logo">
  <h1>تبسيط الإجراءات والتحول الإلكتروني لمحافظة نينوى
الخدمة الأولى: تسجيل بيانات المواطن / المختار</h1>
  <!-- <p style="color: white;">تبسيط الإجراءات والتحول الإلكتروني لمحافظة نينوى
    الخدمة الأولى: تسجيل بيانات المواطن / المختار</p> -->
</div>

<div class="container">
  <div class="row">
    <!-- Login Box -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-sign-in-alt icon"></i> Login
        </div>
        <div class="card-body">
          <form>
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password">
            </div>
            <button type="submit" class="btn btn-primary btn-block" onclick="handleLogin(event)">Login</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Register Citizenship Box -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <i class="fas fa-id-card icon"></i> Register Citizenship
        </div>
        <div class="card-body">
          <form id="registerForm">
            <div class="form-group">
              <label for="citizenName">Full Name</label>
              <input type="text" class="form-control" id="citizenName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
              <label for="citizenPhone">Phone Number</label>
              <input type="tel" class="form-control" id="citizenPhone" placeholder="Enter your phone number" required>
            </div>
            <div class="form-group">
              <label for="citizenEmail">Email Address</label>
              <input type="email" class="form-control" id="citizenEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
              <label>Family Information</label>
              <input type="number" id="familyCount" class="form-control mb-2" placeholder="Number of family members" min="1" required>
            </div>
            <div id="familyDetails"></div>
            <div class="form-group">
              <label for="citizenAddress">Full Address</label>
              <input type="text" class="form-control mb-2" id="area" placeholder="Area" required>
              <input type="text" class="form-control mb-2" id="streetNumber" placeholder="Street Number" required>
              <input type="text" class="form-control mb-2" id="houseNumber" placeholder="House Number" required>
            </div>
            <div class="form-group">
              <label for="housingStatus">Housing Status</label>
              <select id="housingStatus" class="form-control" required>
                <option value="">Select Status</option>
                <option value="owner">Owner</option>
                <option value="tenant">Tenant</option>
              </select>
            </div>
            <div class="form-group">
              <label for="selfImage"> Self Image (Mandatory)</label>
              <input type="file" class="form-control mb-2" id="selfImage" required>
            </div>
            <div class="form-group">
              <label>Upload Required Documents</label>
              <div>
                <label for="nationalId">National ID (Mandatory)</label>
                <input type="file" class="form-control mb-2" id="nationalId" required>
              </div>
              <label for="anotherId">Other ID (e.g., Ration Card, Residence Card, etc.)</label>
              <input type="file" class="form-control" id="anotherId" required>
            </div>
            <button type="submit" class="btn btn-success btn-block">Register</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('familyCount').addEventListener('input', function () {
    const familyDetails = document.getElementById('familyDetails');
    familyDetails.innerHTML = '';
    const count = parseInt(this.value, 10);

    for (let i = 1; i <= count; i++) {
      familyDetails.innerHTML += `
        <div class="mb-3 border p-3 rounded">
          <h5>Family Member ${i}</h5>
          <div class="form-group">
            <label>Name</label>
            <input type="text" class="form-control" id="familyMemberName${i}" required>
          </div>
          <div class="form-group">
            <label>Age</label>
            <input type="number" class="form-control" id="familyMemberAge${i}" required>
          </div>
          <div class="form-group">
            <label>Upload Image</label>
            <input type="file" class="form-control" id="familyMemberImage${i}" required>
          </div>
        </div>
      `;
    }
  });

//   function generateRandomCode() {
//     const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
//     let code = '';
//     for (let i = 0; i < 6; i++) {
//       code += chars.charAt(Math.floor(Math.random() * chars.length));
//     }
//     return code;
//   }

//   document.getElementById('registerForm').addEventListener('submit', function (event) {
//     event.preventDefault();

//     const citizenData = {
//       name: document.getElementById('citizenName').value.trim(),
//       phone: document.getElementById('citizenPhone').value.trim(),
//       email: document.getElementById('citizenEmail').value.trim(),
//       familyMembers: [],
//       address: {
//         area: document.getElementById('area').value.trim(),
//         streetNumber: document.getElementById('streetNumber').value.trim(),
//         houseNumber: document.getElementById('houseNumber').value.trim(),
//         housingStatus: document.getElementById('housingStatus').value.trim()
//       },
//       documents: {
//         nationalId: document.getElementById('nationalId').files[0]?.name,
//         anotherId: document.getElementById('anotherId').files[0]?.name
//       },
//       selfImage: document.getElementById('selfImage').files[0]?.name,

//       uniqueCode: generateRandomCode()
//     };

//     const familyCount = parseInt(document.getElementById('familyCount').value.trim(), 10);
//     for (let i = 1; i <= familyCount; i++) {
//       citizenData.familyMembers.push({
//         name: document.getElementById(`familyMemberName${i}`).value.trim(),
//         age: document.getElementById(`familyMemberAge${i}`).value.trim(),
//         image: document.getElementById(`familyMemberImage${i}`).files[0]?.name
//       });
//     }

//     let allCitizens = JSON.parse(localStorage.getItem('citizens')) || [];
//     allCitizens.push(citizenData);
//     localStorage.setItem('citizens', JSON.stringify(allCitizens));

//     alert(`Citizen registered Unique code is sent to ${citizenData.email}.Or take screenshot of Unique code: ${citizenData.uniqueCode}`);
//     this.reset();
//   });
// //   function handleLogin(event) {
// //   event.preventDefault();
// //   const email = document.getElementById('loginEmail').value.trim();
// //   const password = document.getElementById('loginPassword').value.trim();

// //   const hardcodedUsers = {
// //     "admin@gmail.com": { password: "admin", role: "Admin" },
// //     "mukhtar@gmail.com": { password: "123456", role: "User" },
// //     "governor@gmail.com": { password: "123456", role: "Governor" },

// //   };

// //   const allCitizens = JSON.parse(localStorage.getItem('citizens')) || [];

// //   // Check for hardcoded users
// //   if (hardcodedUsers[email] && hardcodedUsers[email].password === password) {
// //     localStorage.setItem('userRole', hardcodedUsers[email].role);
// //     alert(`Welcome ${hardcodedUsers[email].role}`);
// //     window.location.href = "mukhtarInterface.html";
// //     return;
// //   }

// //   // Check for registered citizens
// //   const citizen = allCitizens.find(
// //     (cit) => cit.email === email && cit.uniqueCode === password
// //   );

// //   if (citizen) {
// //     alert('Welcome Citizen!');
// //     localStorage.setItem('citizenemail', email);

// //     window.location.href = "citizenInterface.html";
// //   } else {
// //     alert('Invalid login credentials');
// //   }
// // }

document.getElementById('registerForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const citizenData = {
    name: document.getElementById('citizenName').value.trim(),
    mobileNo: document.getElementById('citizenPhone').value.trim(),
    email: document.getElementById('citizenEmail').value.trim(),
    area: document.getElementById('area').value.trim(),
    streetNumber: document.getElementById('streetNumber').value.trim(),
    houseNumber: document.getElementById('houseNumber').value.trim(),
    housingStatus: document.getElementById('housingStatus').value,
    familyMembers: [],
  };

  const familyCount = parseInt(document.getElementById('familyCount').value.trim(), 10);
  for (let i = 1; i <= familyCount; i++) {
    citizenData.familyMembers.push({
      name: document.getElementById(`familyMemberName${i}`).value.trim(),
      age: document.getElementById(`familyMemberAge${i}`).value.trim(),
    });
  }

  // Send the citizen data as JSON
  fetch('http://localhost:8082/citizen/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'  // Set Content-Type to application/json
    },
    body: JSON.stringify(citizenData)  // Send JSON data
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Registration failed. Please try again.');
    }
    return response.json();
  })
  .then(data => {
    alert(`Registration successful! Unique Code: ${data.uniqueCode}`);
    document.getElementById('registerForm').reset();
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message);
  });
});

function handleLogin(event) {
  event.preventDefault();

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  // Make API call to authenticate
  fetch('http://localhost:8082/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      username: email,
      password: password
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Invalid login credentials');
    }
    return response.json();
  })
  .then(data => {
    // Extract roles and jwtToken
    const userRole = data.roles[0]; // Assuming at least one role exists
    const jwtToken = data.jwtToken;

    // Save to localStorage
    localStorage.setItem('username', data.username);
    localStorage.setItem('name', data.name);
    localStorage.setItem('userRole', userRole);
    localStorage.setItem('jwtToken', jwtToken);

    alert(`Welcome, ${data.name}! Your role is ${userRole}.`);

    // Redirect based on role
    if (userRole === 'GOVERNOR') {
      window.location.href = "governorInterface.html";
    } else if (userRole === 'CITIZEN') {
      window.location.href = "citizenInterface.html";
    } else {
      alert("Unauthorized role. Please contact support.");
    }
  })
  .catch(error => {
    alert(error.message);
  });
}

</script>

</body>
</html>
